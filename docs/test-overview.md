# Poetry 新系统 — 测试文档（动态 + SQLite）

## 测试范围

覆盖 [product-overview.md](product-overview.md) 中动态方案下的 P0/P1 功能：

- **诗词**：列表（默认/分页）、按朝代/标签/关键词筛选、详情（正文/拼音/注释/译文/赏析）、阅读设置、朗读（详情页朗读全文/停止）、全局搜索（请求 API）。
- **作者**：列表（API 分页）、详情、作者下诗词列表。
- **朝代**：朝代列表（/api/dynasties）、该朝代下诗词/作者浏览。
- **打印与赞赏**：打印诗词、赞赏入口与列表展示（静态）。
- **不覆盖**：登录、后台、Webhook、服务端访问量；数据来自 SQLite，seed 在 build 中执行，无需单独配置库。

## 测试环境与数据

- **环境**：对**构建后的 Next 服务**进行测试。本地执行 `npm run build`（会先执行 gen_markdown/seed_db 再 next build）后，使用 `next start` 或部署到测试环境（如 Vercel）后访问；数据来自 SQLite 单库，无需单独配置数据库（seed 在 build 中执行）。
- **数据要求**：构建时 seed_db 已从 POEMS_DIR 入库，包含若干朝代、作者、诗词（含拼音/注释/译文/赏析），便于覆盖列表与详情。

## 测试用例（节选）

| 编号 | 功能 | 步骤概要 | 预期 | 优先级 |
|------|------|----------|------|--------|
| TC-01 | 诗词列表 | 打开诗词列表页 | 展示列表，左侧有朝代/标签导航；支持分页；数据来自 /api/poems 等 | P0 |
| TC-02 | 按朝代筛选 | 选择某朝代 | 列表仅显示该朝代诗词；左侧朝代导航当前项高亮 | P0 |
| TC-03 | 诗词详情 | 点击某诗词进入详情 | 展示标题、正文、**字级拼音**（Unicode 声调符号如 nǐ）、注释/译文/赏析（若有）；布局为主内容 + 右侧边栏，作者信息在右侧 | P0 |
| TC-04 | 阅读设置 | 在详情页切换拼音显隐等 | 五项（简体/繁体、正文字体、拼音标注、原文注解）均可切换且**真实生效** | P0 |
| TC-04b | 朗读 | 在详情页点击朗读全文、停止 | 点击「朗读全文」可播放中文朗读；点击「停止」立即停止；朗读内容随简繁设置 | P0 |
| TC-05 | 全局搜索 | 头部右侧搜索框输入关键词触发搜索 | 头部右侧有搜索框、主题切换与 GitHub；请求 /api/poems?q= 等返回匹配诗词列表 | P0 |
| TC-06 | 作者列表与详情 | 打开作者列表，进入某作者详情 | 展示作者信息及诗词列表（API 或服务端查库） | P0 |
| TC-07 | 朝代维度 | 进入朝代列表，选择某朝代 | 可浏览该朝代下诗词/作者 | P0 |
| TC-08 | 登录与受保护 | — | **N/A（本期不实现）** | — |
| TC-09 | 后台诗词列表 | — | **N/A（本期不实现）** | — |
| TC-10 | 打印与赞赏 | 打开打印/赞赏相关入口 | 打印可用；赞赏信息静态展示 | P1 |

完整用例可在本文件或子文档中按模块补充；新增功能时同步补充用例与验收标准。

## 验收标准

- 所有 P0 用例通过（TC-08/TC-09 除外）。
- P1 用例按本期实现范围通过或标注为后续迭代。
- 无未修复的 P0/P1 缺陷。
- 文档与代码一致；变更需求或数据格式时同步更新本文档与产品/技术文档。

## 回归范围

随迭代维护：每次发布前回归本期改动涉及的模块（诗词/作者/朝代）及上述 P0 用例；数据格式或构建/seed 脚本变更时做全量 P0 回归。

## 分层测试与脚本（L1/L2/L4）

- **L1 构建与脚本**：gen_markdown 自测可用 Vitest/Jest 对样例 JSON → 产出 .md 路径与内容做断言（依赖 CHINESE_POETRY_DIR）；gen_markdown 完成后提示执行 `npm run build`；build 可执行性依赖 `scripts/seed_db.ts` 与 `scripts/ensure_poems_then_build.ts`。
- **L2 构建产物断言**：执行构建产物检查脚本（如 `npm run check:build`），依赖先执行过 `npm run build`。检查**动态构建**：`.next/` 存在；可选请求本地 `/api/dynasties` 或 `/api/poems?dynasty=tang&page=1&limit=1` 返回 200 与合法 JSON。诗详情页纠错链接为 `poems/author_slug/title_slug.md` 形式。若启用**分层 SSG**（`BUILD_SSG_POEM_LIMIT` / `BUILD_SSG_AUTHOR_LIMIT` > 0），构建会预渲染部分诗/作者页，校验时仅需确认预渲染数量在设定范围内，非全量预渲染。详见 [scripts/check_build_output.ts](../scripts/check_build_output.ts)。
- **L4 MASTER 自检**：交付前按 [design-system/poetry/MASTER.md](../design-system/poetry/MASTER.md) 文末 Pre-Delivery Checklist 逐项勾选。**prefers-reduced-motion** 为后续迭代，本期可不强制通过。

## 界面与功能测试执行记录（L3）

在本地 Next 服务（`next start`）或部署环境下执行 P0/P1 用例的示例结果：

| 用例 | 结果 | 备注 |
|------|------|------|
| TC-01 诗词列表 | 通过 | 列表、搜索框、随机入口正常；数据来自 API |
| TC-02 按朝代筛选 | 通过 | 从首页进「唐」列表正常 |
| TC-03 诗词详情 | 通过 | 直接 URL 正常；从列表/朝代页点击诗链接可进入详情 |
| TC-04 阅读设置 | 通过 | 拼音/正文字体/原文注解开关可切换 |
| TC-04b 朗读 | 通过 | 朗读全文/停止可播放与停止；随简繁生效 |
| TC-05 全局搜索 | 通过 | 数据来自 /api/poems?q= 等 |
| TC-06 作者列表与详情 | 通过 | 直接 URL 与从列表跳转正常 |
| TC-07 朝代维度 | 通过 | 朝代列表与按朝代诗词/作者正常 |
| TC-10 打印与赞赏 | P1/后续 | 赞赏为 P1 或未实现；打印入口可访问；贡献页 /contribute 已实现 |
